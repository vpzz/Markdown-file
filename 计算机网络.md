# 概述

1. 计算机网络的基础是计算机和通信技术。
2. 三网融合 电信网络（有线和移动电话），计算机网络（其中最大的称为因特网，还包括其他的政务网，军网等），有线电视网络（大多是单向的）。
3. 多个计算机通过集线器，交换机连接在一起，就称为网络，网络中的设备称为结点，网线称为链路。网络和网络之间使用了路由器连接起来，就成为互联网。
5. 交换机的网口较多，路由器则较少，前者主要连接主机，后者主要连接网络（即路由器和交换机）。
6. 除了有网络设备，还要有协议才可以使得网络工作。协议规定了交换信息的格式，顺序以及发生事件时才去的动作。这些协议由RFC文档规定。
7. 因特网（Internet）特指全球最大的互联网（internet），是网络的网络。Internet由国家级的ISP(Internet service provider)组成，国家的ISP由区域性的ISP组成。
8. 1969年分组交换的美国国防部APRAnet产生。后来将多个网络相连，构成互联网，1983年，TCP/IP协议成为互联网的主要协议。
9. TCP/IP最初开发的时候是为国防部服务的，没有考虑太多的外来设备接入，安全性不足。
10. 1985年开始逐步建成了3级结构的因特网，终端→区域网→主干网。如今变成由多层次ISP构成的因特网。
11. 各层ISP的IP地址都是实现分配好的，因此可以根据IP来查询归属地。如果服务器的服务范围越大，就应越接近核心ISP。
13. 各个ISP内部的带宽较高，但是ISP之间的带宽较低。较大的网站一般都会在各个ISP有服务器，或者部署在双线机房。
14. ![1587693807970](计算机网络.assets/1587693807970.png)
15. 主机之间的通信方式可以使C/S(谁主动发起请求，谁就是客户；服务端要事先开启好，等待客户端连接)和P2P方式的。
16. 常见的家庭接入网络有
    1. 数字用户线路（DSL），ADSL指的是非对称的DSL（上行速率<下行速率）。使用电话线来传输语音和数据信号。使用了多路复用技术，通过分离器将二者分离开，然后再用调制解调器也就是modem猫将信号解调，接入计算机中。它的好处是可以利用已有的电话网络。DSL使用的多路复用技术为频分多路复用，FDM。0-4kHz用于传输语音信号，4-50kHz用于传输上行信号，50-1MHz用于传输下行信号。
    2. 电缆网络也可以用于传输网络信号，这也是用到频分复用技术。它的前端一般会链接光纤网络，构成HFC混合光纤同轴电缆。一条电缆上的各个用户之间是共享带宽的。而ADSL各家各户是独享带宽的。
17. 机构接入网络大多使用以太网Ethernet。端系统一般直连以太网交换机，速率可到Gbps。
18. 接入网络相互直接互联，是O(n^2)的复杂度，因此可以进一步分层，构件更高层级的网路。
19. <img src="计算机网络.assets/image-20210905233404590.png" alt="image-20210905233404590" style="zoom:50%;" />
20. 主机和交换设备连接，交换设备之间互联，构成交换网络。交换设备可以并行地将数据从输入端口转发到输出端口。
21. 通常情况下，通信线路的通信能力>>一路通信的需求。就好比用光纤来发短信，如果不复用，浪费就很严重。常见的多路复用技术有：
    1. FDM频分复用，将多路基带信号调制到不同频率载波上再进行叠加形成一个复合信号。不同用户占用不同的频率范围。
    2. TDM时分复用，将时间划分为一段一段等长的时分复用帧，每个帧中又划分为小的时隙。每个用户只能在特定的时隙中发送数据。每个用户在自己的时隙中占用所有的频带资源。<img src="计算机网络.assets/image-20210905235022872.png" alt="image-20210905235022872" style="zoom: 67%;" />
    3. WDM波分复用，也就是光的频分复用。
    4. 码分复用CDM。广泛用于蜂窝网络和卫星通信。不对时间和频率进行分离。每个用户会被分配一个唯一的mbit的码片序列，有-1和+1组成，其中-1表示0，+1表示1。各个用户在发送消息时都是用相同的频率载波，不过需要用自己的码片序列x原始数据然后发送出去。为了保证编解码的可逆和不混淆，各个用户的码片序列必须要正交。一个用户要接受另一个用户的消息，应该用该用户的码片序列和消息进行乘积。
22. 数据交换的类型：电路交换，报文交换，分组交换。
23. 因特网的核心部分采用分组交换。
24. 电路交换一般用在电话交换机中，通信的双方之间有单独的连接。通信结束，释放连接。因此打电话之前要先拨号等待电路建立链接。数据不用写地址，接收端是固定的。一个客户端不能同时和两个客户端建立连接，具有资源独占性。该方式适用于数据量很大的实时性传输。核心路由器可能使用电路交换。
25. 报文message就是发送信息的整体。报文交换就是一次性将整个报文发送到目标，交换设备要完全接收到报文才可以进行下一步的转发，要求交换设备的缓存足够大。电报通信使用的就是报文交换。
26. 分组交换就是将报文切割成小块（包，packet），然后添加上首部信息。分组可以独立地逐个发送，中间的路由器根据包的首部来决定如何转发，最终接收端收到后，再根据首部再拼合。交换设备不需要进行拼接，拆分和重组都是在主机中进行，不会对网络设备增加负担，唯一增加的负担就是每个分组都有头部信息，数据量大了。分组交换网络中，一条线路上的主机共享一个带宽上限，每个主机的资源分配不是固定的，这称为统计多路复用。该方法对于缓存的需求较低。
27. 分组转发是流水线工作的，各个交换设备并行工作，效率高于报文交换的串行工作。
28. 分组交换相比于电路交换，它会独占线路，同时由于大多数用户在使用网络时，活动时间占比都是比较小的，例如浏览网页时，下载时间和浏览时间相比很小。分组交换能够支持更多的用户同时使用网络，使得网络资源充分共享。分组交换适用于突发数据信息传输，大部分时间都是休眠，极少数时间发送。通产带宽的
29. 同一个报文的不同包可能走不同的转发路径。线路是可以共享的，不存在专用的问题。不需要先建立连接。
30. 分组交换的可靠性高，一个节点或链路坏掉，其余的仍可以正常工作，通信不受阻。
31. 交换设备具有存储转发的功能，收到的数据包先排队存储，接下来根据包的首部信息处理，决定转发的端口。
32. 报文交换不对文件进行打包，只有一个首部信息。
33. ![1587694639015](计算机网络.assets/1587694639015.png)
34. 分组交换可靠性高，综合速率最快。报文交换中转发设备需要等全部收到后，才能转发。
35. 1994年4月20日中国接入互联网，是64k的专线。
36. ![1587695714677](计算机网络.assets/1587695714677.png)
37. 之前按照作用范围分类，但是现在一般按照使用的技术分为广域网和局域网。
38. 局域网的范围一般在100米以内。
39. 主机和交换机之间连接可以看做是星型网络，路由器之间的网络可以看做网状。交换机之间可以有树形结构，根交换机，分支交换机等。
40. 速率：主机在数字信道上传输数据位数的速率，也称为比特率。一台主机可以同时和多个设备通信，也就是有多个信道。速率是时刻变化的，带宽一般不变。在计算机网络和通信中，k=10^3而不是1024。
41. 通信领域中的带宽指的是信号的最高频率和最低频率的差，单位是Hz。计算机网络中的带宽是数字信道所能传输的最高速率。
42. 当交换设备的缓存满时，会丢弃掉新来的数据包。
43. 吞吐量：单位时间内通过某个网络设备的数据量。各个信道的速率之和。
44. 一个数据包在经过一个网络设备时，会逐步经历如下时延：
    1. 处理时延：差错检查，确定输出链路，取决于交换设备的性能，一般在ms以下
    2. 排队时延：取决于交换设备当前的拥塞状况，不确定性最大。
    3. 发送时延：取决于分组大小，链路带宽，取决于交换设备的性能
    4. 传播时延：（取决于链路长度，信号传播速度，大约为0.7光速![1587696545720](计算机网络.assets/1587696545720.png)
45. 时延带宽积=传播时延x带宽。相当于在链路上动态容纳的数据量。
46. 吞吐量throughput：表示在发送端与接收端之间传送数据的速率。取决于端到端之间的瓶颈链路。
47. RTT（Round trip time）往返时间，ping 命令显示的时间是一去一回的时间。
48. 信道利用率：有数据通过的时间/总体的时间，利用率越高，时延越大。

# 网络体系结构

1. 分层的目的是高内聚，低耦合。各环节依赖性低。
2. OSI7层模型中各层的功能：
   1. 应用层，和用户交互的界面。
   2. 表示层，对数据进行加密，压缩，编码等。大端和小端的转换。
   3. 会话层，客户端和服务器建立的会话，每访问一个网站都会建立。木马一般在会话层，没有应用层的界面。
   4. 传输层，进行可靠传输TCP（建立会话），不可靠传输UDP（不建立会话），流量控制。
   5. 网络层，IP地址编址和选择最佳路径。
   6. 数据链路层，数据封装，添加物理层地址，MAC。这里的物理地址只能是相邻节点之间的寻址。
   7. 物理层，规定网络设备接口标准，和传输介质链接，解决单一bit传输的问题。
3. OSI模型是为了支持异构网络的通信，理论上是成功的，但是实践上是失败的。
4. 每一层协议处理的是PDU，协议数据单元。应用层的数据经过下面的每一层都要加上头部，而数据链路层还会加上尾部。物理层不会加头或尾，直接将数据链路层过来的数据传输过去。数据链路层的PDU一般称为帧。增加的头部通常包含，地址信息，差错控制信息，优先级，服务质量等。
5. 数据链路层之所以要既加头又加尾，是为了方便从物理层获得bit流中切分出来帧。之所要加入地址信息，是因为数据链路层有些是广播通信，例如集线器，所有主机都能受到帧，但是只有接受地址的主机会保留该帧。
6. 网络层负责源主机到目的主机分组的交付。为了保证跨网络的通信，每个主机需要一个惟一的地址。网络层还要负责路由功能，即根据目的主机地址选择走何种线路。在设备间传输时，数据帧的源和目标物理地址一直在发生变化。而网络分组的源和目的地址始终不变，因此需要网络地址全局唯一。网络层是主机↔主机主机的传输，用ip地址来标识主机。
7. 会话层的PDU报文会在传输层中被拆分为等大小的段segment。传输层是进程↔进程之间的传输，用端口号来标识进程。tcp协议工作在传输层，可以建立端到端的逻辑链接。
9. 网络工程师主要负责下面的4层，其实物理层也不用配置，已经有现有标准。程序员主要负责上面的3层。
10. 上面4层是端到端的层，下面三层是链路之间的层。
11. <img src="计算机网络.assets/image-20210906194704921.png" alt="image-20210906194704921" style="zoom:67%;" />
12. 木马和病毒不同，病毒是为了破坏计算机，木马多半是为了控制计算机或盗窃信息。
13. 下层向上层提供服务，协议是同一层的实体沟通的约定。服务是垂直的，协议是水平的。不同层的协议是无关的。上下层之间通过接口来定义。
14. 网络排错需要从底层到高层来进行。
15. 五层模型是综合了OSI七层模型和TCP/IP四层模型的。
16. ![1587699119154](计算机网络.assets/1587699119154.png)
17. ![1587699245795](计算机网络.assets/1587699245795.png)
18. 数据切割成数据段，加上IP地址变成数据包，加上MAC地址，变成数据帧，然后变成比特流。
19. 常用的RJ-45网线接口，有8根线，4对。
20. 更改MAC地址的方法：![1587699711372](计算机网络.assets/1587699711372.png)
21. 速度和双工模式不匹配则不能通信。它规定了通信的节奏。
23. VMware虚拟机的网络可以可以有以下三种模式：

    1. 桥接，将本机的物理网卡和虚拟的虚拟网卡用网桥连接起来，这就好像，本机和虚拟机一起连接在一个交换机的不同接口上，因此他们属于同一个网段，但是ip不能重复，网关需要设置一致。这在本机的上一层路由器或交换机来看，它的一个接口上有两个主机。相当于是下连了一个交换机，本机和虚拟机分别连接到了这个交换机上。这种情况下，虚拟机可以和局域网内的其他计算机通信。这在需要身份认证的网络环境中不太可行，因为交换机可能会拦截未认证的用户的包。
    2. NAT，这里可以把本机看作一个路由器，包含一块VMware Network Adapter VMnet8虚拟网卡，它和虚拟机在一个网段（VMnet8），本机还有其他网卡用于连接到互联网中。虚拟机的网关需要设置为本机，本机为虚拟机提供NAT服务。此时本机局域网内的其他主机不知道虚拟机的存在，但是可以设置本机端口到虚拟机ip和端口的映射，这样就可以通信了。这对于IP地址少或需要认证的网络非常有用。
    3. VMware会产生：虚拟NAT设备，虚拟DHCP服务器，VMnet8虚拟交换机，主机的VMware Network Adapter VMnet8虚拟网卡。虚拟NAT设备两头分别连接主机的物理网卡和VMnet8虚拟交换机。虚拟机的网卡，虚拟DHCP服务器，主机的VMware Network Adapter VMnet8虚拟网卡都会连接到VMnet8虚拟交换机上。VMware Network Adapter VMnet8只是用来进行主机和虚拟机之间通信的，虚拟机连接外网并不需要VMware Network Adapter VMnet8开启。虚拟NAT设备为为本机VMware Network Adapter VMnet8虚拟网卡和虚拟机提供NAT服务。此时本机局域网内的其他主机不知道虚拟机的存在，但是可以设置本机端口到虚拟机ip和端口的映射。在NAT设置中，需要填写网关IP，这个网关就是和NAT合体的虚拟路由器。DHCP服务器一般为DHCP分配范围的最后一个IP，例如192.168.80.254，不过这个DHCP服务器ping不通，只能通过抓取DHCP的报文来发现。
    4. Host-only，使用VMnet1网卡，只能和真实机通信。
24. 在NAT和Host-only模式中，本机还充当DHCP服务器。
25. 真实机一共有3个网卡，一个物理的，两个虚拟的。虚拟机使用NAT和Host-only通信时，需要将真实机和虚拟机的IP设置在同一个网段中。真实机的IP在对应的网卡中。
26. 当真实机有多块网卡时，可以在虚拟网络编辑器中可以选择桥接的网卡。
27. ifconfig 临时设置IP，重启会失效，需要修改配置文件才可以永久生效。也可使用ip addr命令。本机默认存在一块回环网卡，用于本地通信。ifconfig eth0 192.168.xxx.xxx 可以为本机分配IP。
29. 虚拟机中的VMnet相当于一个交换机，虚拟机和真实机都接在这个交换机上。真实机可以设置是否连接到这个虚拟网络。
30. ![1587700040248](计算机网络.assets/1587700040248.png)
28. 本机的网关可以用route -n来查看路由表，第一行的GateWay就是了，如果使用NAT上网，那么虚拟机的网关要设置为下图的IP。

    ```shell
    route -n
    Kernel IP routing table
    Destination   Gateway        Genmask       Flags  Metric  Ref  Use  Iface
    0.0.0.0       192.168.80.2   0.0.0.0        UG     100     0    0   ens33
    192.168.80.0  0.0.0.0        255.255.255.0  U      100     0    0   ens33
    ```
32. ![1587701295813](计算机网络.assets/1587701295813.png)
33. 如果主机可以通过ssh连接上虚拟机，且主机可以ping通虚拟机，但是虚拟机却无法ping通主机，这时应该在主机的防火墙中，打开入站规则→虚拟机监控（回显请求）即可。
35. 可以通过env |grep SSH查看主机和虚拟机的IP。

    ```shell
    zj@zj-hit:~$ env |grep SSH
    SSH_CONNECTION=192.168.80.1 1113 192.168.80.129 22 #可以看到主机ip为.1，端口为1113，虚拟机ip为.129，端口为22。
    SSH_CLIENT=192.168.80.1 1113 22
    SSH_TTY=/dev/pts/3
    ```

# 物理层

1. 网卡发送的是数字信号，然后经过调制解调器变成模拟信号，方便长途传输。局域网的传输不会经过调制解调器，直接传输数字信号。

2. 通常的通信线路包含一条发送信号和一条接受信道。

3. 单工（单向）通信，只能一方发送，一方接受；半双工，双向交替通信，双方都可以发送接受信息，但是不能同时发送，同时接受，对讲机即如此；双向同时通信（全双工），计算机网络一般都是全双工的。

4. 基带信号：来自信源的信号，例如说话的声波。

5. 带通信号：基带信号频率低，传输不远，需要经过载波调制之后，变到较高频率的信道传输。但是这个信号也只能在某个频率范围内通过。

6. 几种基本的调制方法：
   1. 调幅（AM）：载波的振幅随基带数字信号而变化

   2. 调频（FM）：载波的频率随几代数字信号而变化

   3. 调相（PM）：载波的初始相位随基带数字信号而变化

7. 任何信道中，码元的传输速率是有上限的，否则就会出现码间串扰的情况，接收端不能判决。

8. 奈氏准则（无噪声的情况下）：理想低通信道的最高码元传输速率为2W Baud，其中W为理想低通信道的单位，单位为Hz。Baud波特，是码元传输速率的单位。

9. W是介质所决定的。1波特不一定等于1 bit。考虑采样量化编码后，1次采样1个波特，1波特可能代表多个bit。下图中1波特=3 bit，1个码元代表3个二进制数据。3 波特率=比特率。

10. ![1587707035731](计算机网络.assets/1587707035731.png)

11. 香农推到了高斯白噪声下的传输速率：

    ```shell
    #信道的极限信息传输速率
    C = W*log_2(1+S/N) b/s
    #W为信道的带宽（以Hz为单位）
    #S为信道内所传信号的平均功率
    #N为信道内部的高斯噪声功率
    ```

12. 信噪比越大，信息的极限传输速率就越高，但是有上限。实际信道上能够达到的信息传输速率比香农的极限传输速率低不少。

13. ![1587707838305](计算机网络.assets/1587707838305.png)

14. 频率：光纤>同轴电缆>双绞线。

15. 通常使用的网线就是非屏蔽（UTP）的双绞线，相互绝缘的导线对绞来低于低频的干扰，一根导线在传输过程辐射的电磁波被另一根上发出的抵消掉。屏蔽双绞线为STP，适合于长距离传输。

16. 同轴电缆分为50Ω（用于数字传输，基带传输）和75Ω（用于模拟传输）。

17. ![1587709245305](计算机网络.assets/1587709245305.png)

18. 有线电视信号使用同轴电缆传输。光纤信号衰减低，隔120km放大一次，由纤芯（高反射率）和包层（低反射率）组成，形成全反射。分为单模（细）和多模（粗），多模光纤允许以多个角度入射，信号传的多。

19. 无线电通信中短波通信依靠电离层的反射，质量较差；微波通信沿直线传播，需要隔一定距离假设信号塔。

20. 集线器 hub，只起到放大信号和重发的作用。目的是扩大网络的传输范围。是一个冲突域。集线器不查看包信息，会将收到的包转发给所有的端口。不安全。通信效率低，同时通信时，每个端口的速率都会变低。

21. ![1587722001677](计算机网络.assets/1587722001677.png)

22. 复用信道可以提高信道的利用率。

23. 频分复用（FDM）不同用户占用不同的频率范围，可以同时使用信道。基带信号使用不同频段的频率进行调制，叠加之后再传输，收到之后分离，解调即可获得信息。电话就是使用FDM。

24. 时分复用（TDM），将时间分为等长的时间段，每个用户占用固定序列号的时间间隙，周期性出现。用户在不同的时间段占用相同的带宽。可能造成资源的浪费，当某些用户不发送数据时。

25. 统计时分复用（STDM），对之前的每个用户进行编号，即收即走，不一定非得凑够整个帧。VLAN使用这种技术。

26. 波分复用（WDM），和频分复用原理类似。

27. 码分复用（CDM）,2G时代的CDMA。每个站被指派一个惟一的m bit的码片序列，如果发送1，则发送自己的码元，如果发送0，则发送反码片序列。多个站发送信号会进行叠加，向外广播。接收端将收到的信号和自己的码片进行规格化内积，如果是0，则信号不是给自己的。

    ```shell
    #CDMA工作原理
    A: (-1 -1 -1 +1 +1 -1 +1 +1)
    B: (-1 -1 +1 -1 +1 +1 +1 -1)
    C: (-1 +1 -1 +1 +1 +1 -1 -1)
    D: (-1 +1 -1 -1 -1 -1 +1 -1)
    #收到的码片序列
    R: (-1 +1 -3 +1 -1 -3 +1 +1)
    ```

28. 不同的码片序列之间是正交的，规格化内积为0。如上图，规格化内积A\*R=1，B\*R=-1,C\*R=0,D\*R=1。

30. 码分复用的缺点是通信的终端数量越多，码片就越长。传输效率低。

31. ![1587724385934](计算机网络.assets/1587724385934.png)

32. ADSL，把0-4kHz留给语音信号的传输，把原来没有被利用的高频范围留给上网使用。非对称的，下行频率宽，信道可以多一点。上行25个信道，下行225个信道，每个15bit/s。

33. ![1587724529376](计算机网络.assets/1587724529376.png)

34. FTTH是光纤到户。

# 数据链路层

1. 数据链路层使用到的信道主要有：点对点信道（两台主机用网线直接相连）和广播信道（使用网络设备相连）。
2. 点对点信道通信不需要地址，因为除了自己就是对方；但是广播信道中，数据会传送到总线上的其他所有主机，主机通过地址判断是否是发送给自己的。
3. MAC地址中第一个字节的后两位起到标识作用。广播MAC地址为全F。
4. ![1587994636261](计算机网络.assets/1587994636261.png)
5. 每个主机可以配置一个多播组列表，当收到多播帧（第一个字节末位为1）时，回合多播组列表对比，如果有相同的，则接受该帧。给主机配置多播组列表时进行私有应用时，不得使用公有的标准多播地址。
6. 安全机构可能通过移动设备的MAC地址来标识位置，所以现在的系统在扫描网络时开始采用随机MAC地址。
7. 如果不介入因特网，可以只使用MAC地址进行通信。
8. PDU 协议数据单元。
9. ![1587995620858](计算机网络.assets/1587995620858.png)
10. 从上图可以看出来只有IP地址，没有MAC地址似乎也能通信，之所以还有MAC层的存在是为了分层实现和兼容早期的以太网。
11. 因特网必须运行在某种基础网络之上，例如以太网，令牌环网，ATM等，因特网没有定义底层的参数，这些由以太网等定义。IP用于在网络之间通信，MAC用于网络内部通信。
12. 星型结构→网状结构 就是一个去中心化的过程。这样可用性高，容灾性好。
13. 互联网 Internet 、广域网 WAN、局域网LAN可以算作一类，按照区域和范围来分类。
14. 而以太网Ethernet 、ATM网、FDDI网可以算作一类，按照传输技术来分类，属于OSI参考类型的数据链路层。
15. ARP协议中请求广播只有请求的IP对应的主机会应答，别的主机收到之后发现IP地址不是自己，会丢弃。ARP应答虽然是单播的，但是也会传遍整个网络。ARP没有安全验证机制，存在ARP欺骗或攻击。
16. ARP高速缓存中动态获取的记录，默认寿命为2分钟。ARP协议只能在网络内部使用，因为知道其他网络内的主机的MAC地址并没有用，因为如果要发送信息给该主机，目标MAC地址并不是该主机的MAC地址，而是路由器的MAC地址。
17. 链路指的是物理的线路，中间没有节点，除了物理链路外还要有通信协议的控制，才能构成数据链路。
18. 一般的网卡都包含数据链路层和物理层这两层的功能。
19. 数据链路层传输的内容成为帧。将接收到的网络层的数据加上帧头帧尾。
20. 数据链路层要解决的问题：①封装成帧②透明传输③差错控制。
21. 封装成帧就是在一段数据的前后分别添加首部的尾部信息，确定帧的界限。
22. ![1587725931746](计算机网络.assets/1587725931746.png)
23. MTU 最大传输单元，≤1500 Byte。
24. 网络设备如果收到半截子的帧，则会丢掉。
25. 如果传输的内容是ACII码中的可打印字符（95个），帧头尾使用不可打印字符，就不会出现问题，如果传输的内容中包含不可打印字符，其中有可能和帧尾部相同。导致帧的长度变短。为了避免这种情况的发生，会在帧内容中出现结束符的地方添加转义字符。
26. ![1587741479853](计算机网络.assets/1587741479853.png)
27. 插入一个ESC字符（1B）,这个是其它层不知道的情况，称为透明传输。
28. 传输过程中可能会将1变为0，也可能相反，一段时间内，传输错误的比特占总比特的比率成为误码率。
29. 通过循环冗余检验（CRC）技术来检验是否发生了错误。要传输的比特流为101001，然后在后面加3个零（具体是几个，有网络设备协商），然后除以1101（校验码，也是协商的），每一次够除的话会做异或运算，然后将余数（冗余码）替换掉原来加在末尾的0，发送出去。接收方收到数据后，将该数101001001除以1101，如果余数是0，则没问题。
30. ![1587741877016](计算机网络.assets/1587741877016.png)
31. 数据后面添加的冗余码，称为帧检验序列（FCS），CRC是方法，FCS是冗余码。CRC只是FCS的一种方法。
32. 使用CRC技术只能保证无差错接受，要做到可靠传输，还应加上确认和重传。考虑乱序，重复，丢失的情况。
33. 数据链路层如果收到错误的帧，直接丢掉，不会要求对方重传，这个是传输层要解决的问题。
34. PPP，点到点协议，可以进行身份验证，记账。用户直接拨号到ISP。是用的最多的数据链路层的协议。
35. ![1587743099237](计算机网络.assets/1587743099237.png)
36. PPP协议可以标示数据的类型，能承载多种网络层协议。如果是比特流传输，可以使用零比特填充的方法，即遇见连续的1，会在其中插入一个0。
37. 数据链路层的协议都不使用序号和确认机制，因为该层出现差错的几率不大，在因特网环境下，数据链路层的可靠传输不能保证网络层也是可靠的。
38. ![1587743913586](计算机网络.assets/1587743913586.png)
39. 网络设备相连的端口需要使用相同的协议才可以通信。
40. 如果要设计重传，那么发送端在发送完数据后还不能立刻丢弃，需要等接受端确认收到才可以丢弃数据。
41. 使用广播信道的数据链路层
42. 局域网具有广播功能，资源共享。
43. 静态划分信道，需要管理员为每两个主机都划分一个信道，繁琐，已经淘汰。现在多使用动态接入控制，随机接入。
44. 以太网是一种局域网技术，应用最广泛，取代了其他的局域网技术，如令牌环。由施乐Xerox发明。
45. 19世纪科学家们假想宇宙到处弥漫着一种称为以太的物质，作为光的传输介质。但是迈克尔逊-莫雷试验否定了以太的存在。施乐取名以太网的原因是想让物理线路当做以太传输电磁波一样，传输信息。
46. 标准的拓扑结构为总线型。所有的信号都在共享的线路上传输，即使信息只是想发给某一个终端，却会使用广播的形式，发送给线路上的所有计算机，正常情况下，网卡会过滤掉不是发送给自己的信息，除非是网卡处于混杂模式。
47. 以太网使用CSMA/CD协议，载波监听多点接入/碰撞检测。载波监听是每个站在发送数据前会先检查一下总线上是否有其他计算机在发送数据，避免发生碰撞。
48. 碰撞检测就是计算机一边发送数据，一边检测信道上的电压，如果发生较大的波动，则表示发生了冲突，他会立即停止，等一个随机时间，再进行发送。
49. ![1587747238103](计算机网络.assets/1587747238103.png)
50. 距离越长，发送数据后检测到冲突的间隔越长。最长为2倍的传输耗时。所以以太网不宜太长，否则冲突占时太多。
51. CSMA/CD只能进行半双工通信。每个站在发送数据后的一小段时间内，都存在的碰撞的可能性，这导致以太网的平均通信量远小于最高速率。
52. 以太网的端到端时延2τ称为争用期，或碰撞窗口。过了这时间没产生碰撞，才可以确认没有碰撞。一般取51.2μs。
53. 对于10Mbps以太网，这个期间发送64Byte。如果前64个字节没有发生冲突，则后续的数据就不会冲突。同时也是一检测到冲突，就立即停止发送。因此以太网规定了最短有效帧尾64Byte，长度小于该数值的都是因冲突而异常终止的帧。如果不够64Byte，则补0。
54. 基本退避时间取和争用期一样长，采用二进制指数类型退避算法确定退避时间。![1587747908568](计算机网络.assets/1587747908568.png)
55. 以太网的两个标准：
    1. DIX Ethernet V2是世界上第一个局域网产品（以太网）的规约。
    2. IEEE的802.3标准，他和上面的标准只有很小的差别，因此可以将802.3局域网近似简称为以太网。

56. 为了使数据链路层能够更好地适应多种局域网标准，802委员会将局域网的数据链路层拆分为2个子层，
    1. 逻辑链路控制 LLC（Logical Link Control）子层
    2. 媒体接入控制 MAC（Medium Access Control）子层
57. 但是由于TCP/IP体系经常使用DIX Ethernet V2，而不是802.3标准中的几种局域网，因为802委员会制定LLC子层作用不大了，很多厂商在适配器上仅装有MAC协议，而没有LLC协议。
58. 以太网提供的是不可靠的服务，即尽最大努力交付。
59. 传统的以太网最早使用粗同轴电缆，后来使用细同轴电缆，最后发展为双绞线，每个站都需要2对双绞线，一对发送，一对接受。
60. 现在集线器都是用集成电路来实现，自己发送的自己收不到。
61. 集线器很像一个多接口的转发器，工作在物理层，和网线一样，不认识包中的数据。
62. 以太网标准，10Base-T表示10Mbps，基带信号，双绞线。FE(Fast Ethernet)百兆以太网，GE(Gigabit Ethernet)千兆以太网。
63. ![1587815045154](计算机网络.assets/1587815045154.png)
64. 一个帧开始发送时可能会遇到多次碰撞，然后才能发送，T0为发送时延=帧长度/发送速率。然后经历τ时间到达目的地。
65. 以太网信道利用率a=τ/T0，所以线路不宜太长，否则τ会变大，传输的帧不宜太小，否则T0会变小。
66. 理想情况下，都不发生碰撞，那么信道利用率的极限为T0/(T0+τ)。
67. 每个网卡上都有硬件地址，也成物理地址，MAC地址。一共有48位，前24为是分配的，代表厂家，后24位是厂家自己编号。MAC地址扫描工具可以通过MAC地址判断网卡型号。
68. 网卡根据帧的目标MAC地址来判断接受还是丢弃，收到的帧一共分为3种，单播（一对一），广播（一对全体 FF:FF:FF:FF:FF:FF），多播（一对多）。
69. 所谓的修改MAC地址，就是让网卡不适用芯片上的MAC地址，使用指定的。
70. 一个局域网内（同一个交换机下）的MAC地址冲突也不能正常上网。
71. 以太网用的是差分曼彻斯特编码，电压为0时，表示数据传输结束，所以MAC帧没有而结束标识符。
72. ![1587820444333](计算机网络.assets/1587820444333.png)
73. 帧间的最小间隔为9.6μs，相当于96个bit的发送时间，一个站在检测到总线空闲时，还要等待9.6μs才会再次发送数据，这么做的目的是为了使接收方来得及处理刚接收到的帧，做好接受下一帧的准备。
74. 在物理层上考虑扩展，可以将主机和集线器之间使用光纤调制解调器。树形的集线器网络会产生更大的冲突域，通信效率降低。
75. ![1587824868377](计算机网络.assets/1587824868377.png)
76. 在数据链路层上考虑扩展，可以使用网桥。根据MAC帧的目的地址进行转发。具有过滤帧的作用。不是机械地向所有的接口转发。
77. 网桥的每个端口都连接一个集线器，会根据收到的包中的source来判断某个MAC地址处于哪个局域网中，不断地学习（自学习算法），记录包的源地址和进入到网桥的端口到自己的表中（还会记录帧进入端口的时间，为了使得拓扑变化后，方便更新规则），就可以起到过滤的作用了。将冲突域分隔开了。
78. 网桥是早期的两端口二层网络设备。可以使不同速率的局域网互联。存储转发增加了时延。没有流量控制的功能。网桥对局域网的站点是透明的，不可见的，主机并不知道是否经过了网桥。
79. 现将收到的包的源地址和转发表对照，如果没有，则记录，如果有，则更新，然后将包的目标地址和转发表对照，如果有则只转发对应的端口，如果没有则转发其他所有的端口。如果和进来的端口一样，则丢弃。
80. 交换机（switch）就是高速的网桥，以前集线器和网桥结合的方式被交换机直连主机取代。
81. 通常说的10M交换机，指的是每个端口都是10M，端口带宽独享。如果有24口，则背板带宽有240M。
82. 和交换机相连的主机可以设置为全双工。以往的集线器/网桥中则不可以。
83. ![](计算机网络.assets/1587827119775.png)
84. 交换机的左边端口对应2个MAC地址，即PC0和PC1。其余的口都只对应一个MAC地址。
85. 透明网桥使用了生成树算法，可以避免产生有些帧在网络中兜圈子，不断地转发，始终达不到目的地。
86. 为了提高网络的可靠性，添加了冗余链路，但是也形成了网络环路。广播帧会在环路内产生广播风暴，占用网络资源，同时也会使得交换机的交换表震荡（反复更新），因为它会从不同的端口收到同一个包。
87. 以太网交换机使用生成树协议（STP）来解决环路问题。使得网络的逻辑拓扑是树形的（无环），
88. 交换机会逻辑上设置某些端口为阻塞，从而构成树结构。当网络中发生变化时，交换机又可以启用阻塞点端口。
89. 生成树算法（SPA）是生成树协议的核心，可以在有物理环路的网络中，构建出能够连通所有节点的树形逻辑拓扑。
90. 三个步骤：①选举根交换机②选举根端口③选举指定端口并阻塞备用端口。        “选举”是指各交换机间相互发送生成树协议专用的BPDU数据帧来实现的。
91. 网桥ID（优先级+基本MAC地址）最小者当选根交换机，交换机可以看做是多端口的网桥。优先级的范围为0-61440，步长为4096，默认值为32768。
92. 交换机的每个端口都有一个MAC地址，除此之外，交换机还有一个基本的MAC地址，是VLAN 1 的MAC地址。
93. 在每一个非根交换机上选举一个根端口，有且仅有一个，用来接收根交换机发来的BPDU，生成树结束后，也用来转发普通用户流量。规则：到根交换机的路径成本最小，对端网桥ID最小，对端的端口ID（端口优先级+端口号）最小。
94. 在每个网段选举出一个指定端口，有且只有一个，用来转发根交换机发来的BPDU，也用来转发普通流量。![1587830669705](计算机网络.assets/1587830669705.png)
95. ![1587830838593](计算机网络.assets/1587830838593.png)
96. VLAN组网是有了交换机才可以的，将不在一个交换机上相连的主机组成一个虚拟局域网。
97. 一个VLAN=一个广播域=逻辑网段（子网）
98. 使用一个或多个交换机连接起来的交换式以太网，所有站点都处于同一个广播域中，TCP/IP协议栈中有很多协议都会使用广播，例如ARP（地址解析协议），RIP（路由信息协议），DHCP（动态主机配置协议）。
99. 分隔广播域的方法：①使用路由器，因为路由器默认不对广播包进行转发，但是成本较高。②VLAN
100. VLAN的实现机制，在交换机上实现，需要交换机满足两个条件：①能够处理带有VLAN标记的帧，即IEEE802.1Q帧②交换机的端口支持不同的端口类型。
101. IEEE802.1Q帧对以太网的MAC帧进行了扩展，插入了4字节的VLAN标记，这个动作成为打标签。
102. ![1587912197033](计算机网络.assets/1587912197033.png)
103. VLAN标记的最后12个比特，成为VLAN标识符VID，标识了以太网帧属于哪个VLAN，有效取值为1-4095。
104. 交换机收到普通以太网帧时，会打标签，当转发该帧时，可能会去标签。
105. 交换机的端口类型一般分为Acess，Trunk，Hybrid（华为专有）。交换机每个端口都有且只有一个Port  VLAN ID，简称为PVID，缺省值为1。即所有端口默认都处于VLAN 1下。
106. Acess端口一般用于连接用户计算机，只能属于1个VLAN，端口的PVID值和端口所属的VLAN ID相同，通过更改该PVID值，来划分VLAN。
107. 交换机首次通电后，会默认配置各端口属于VLAN1，默认配置各端口为Acess。
108. ![1587913548544](计算机网络.assets/1587913548544.png)
109. Trunk端口一般用于交换机之间或交换机和路由器之间的互联。可以属于多个VLAN，需要手动配置才行。
110. ![1587913967285](计算机网络.assets/1587913967285.png)
111. Trunk端口接收到已打标签的帧，会直接转发。这里的接受都是指从端口进入交换机。
112. Trunk会始终将交换机各端口收到的信息转发出去，不一定的是是否会去标签转发。
113. 互联的Trunk端口的PVID值如果不相等，有可能会出现转发错误。保险的做法是设置Trunk端口的PVID值相同，这样就肯定不会出错。
114. Hybrid端口会维护一个去标签列表，只有正确地去标签，主机才能看懂MAC帧。
115. ![1587915027101](计算机网络.assets/1587915027101.png)
116. 配置VLAN的步骤：在交换机的VLAN 数据库中创建新的VLAN，然后设置特定的端口端口类型，划归到应该在的VLAN中即可。所有端口默认属于VLAN1。不同的VLAN之间是不能通信的，广播包也不会传递过去。
117. 虽然说交换机是不认识用户的IP的，因为他工作在数据链路层，不回去解析数据包中的IP地址的，但是局域网内如果不配置IP地址，则是不能通信的。
118. 局域网内的主机如果要发送一个广播包，则要设置接收方的IP为255.255.255.255，同时网卡会将接收方的MAC地址设置为FF-FF-FF-FF-FF-FF。
119. 交换机中维护者两个表，MAC表和ARP表。
120. MAC表记录：VLAN→MAC地址→端口     该表只有交换机，路由器才有。交换机的端口没有IP和MAC地址。因为没有主机发送的数据包的目的地址是它，他对于主机来说是透明的。MAC地址是用来标识发送方和接收方的，交换机不属于任何一方。
121. MAC表记录VLAN的转发规则。
122. ARP表记录：IP地址→硬件地址→网卡。
123. 主机只维护一个ARP表，该表通过ARP请求学习得来，当要发送数据包时，会先查询目的IP对应的MAC地址（填写到MAC帧中）和本机的端口（确定从哪个端口转发出去，一般来说主机只有一个网卡，也就只有一个端口）。
124. 二层交换机（即不具有路由功能的，不识别IP）的ARP表示空的，或者说没有ARP表。二层交换机在转发是使用MAC表，查询目的MAC地址对应的端口。三层交换机在转发时，使用ARP表，查询目的IP的MAC地址，然后根据MAC地址寻找对应端口。
125. 路由器中只有ARP表，没有MAC表。

# 网络层

1. 在TCP/IP协议栈中，网络层提供无连接，不可靠的数据报服务。而ATM，帧中继，X.25提供的是面向连接，可靠的虚电路服务。
2. 网络层主要的目的是实现网络互联，实现数据包在各网络之间的传输。
3. ![1587915441137](计算机网络.assets/1587915441137.png)
4. 路由器的每个端口都有一个IP地址，接入到一个不同的网络中。路由器间的网络可以忽视，只保留各个路由器之间的连线。
5. 路由器维护路由表，将接收到数据包中的目标地址在路由表中查询，决定转发端口。
6. TCP/IP协议栈分为4层，它将物理层和数据链路层合并为网络接口层。
7. 网络层提供两种服务：①面向连接的虚电路服务，可靠通信有网络来保证，分组只需携带要走的虚电路的编号即可，所有分组走的路径相同②无连接的数据报服务，可靠通信由用户主机保证，每个分组必须携带目的主机的完整地址，可走不同的路径。
8. 数据报服务，可能发生误码，丢失，重复，失序。因此路由器可以设计的简单，价格低廉。将复杂的网络处理功能置于网络的边缘。因特网使用该服务。
9. 计算机配置IP地址时，其中的网关gateway就是路由器接入到该局域网的端口的IP地址。如果一个局域网内连接多个路由器，则可以为主机配置多个网关来使用。网关的地址一般都使用本网段的第一或最后一个地址。
10. 网络层常见的协议，一般认为ARP和RARP是一个协议：

    1. 地址解析协议 ARP（Address Resolution Protocol）
    2. 逆地址解析协议 RARP （Reverse Address Resolution Protoco）
    3. 网际控制报文协议 ICMP （Internet Control Message Protocol）
    4. 网际组管理协议 IGMP （Internet Group Management Protocol）

11. ![1587955877739](计算机网络.assets/1587955877739.png)
12. 2011年IPv4地址分配完毕，IP地址的经历了三个阶段：①分类编址②划分子网③无分类编址。
13. 只有A、B、C类地址可以分配给主机或路由器的接口。主机号全0为网络地址，标识该网络，主机号全1为广播地址，这两个都不能分配给主机或路由器接口。
14. 整个127A类网络中的任意一个地址都是本地环回测试地址。一共256\*256\*256。
15. 第一个A类网络0也保留不指派。所以A类网络可用1.0.0.0-126.0.0.0。每个网络可用主机号有2^24-2个。
16. 早期，128.0和192.0.0是保留地址，而在RFC3330中，128.0和192.0.0已经可以分配了。
17. 通过左起第一个十进制数可以判断是哪一类地址，1-126为A类，128-191为B类，192-223为C类。
18. DHCP数据包中的source地址都是0.0.0.0，因为要获取IP的主机此时还没有IP，因此只能填0.0.0.0，相当于一个占位符。
19. ![1587917934421](计算机网络.assets/1587917934421.png)
20. ![1587918054830](计算机网络.assets/1587918054830.png)
21. 0.0.0.0 一般称为unspecified，即未指定地址，服务器不指定哪些IP可以访问时，可以设置为0.0.0.0。严格的说，0.0.0.0已经不是一个IP地址了，而是一个集合，所有不清楚（本机路由表中没有特定条目指定如何到达）的主机和目标网络。三无人员收容所。
22. 255.255.255.255只能作为目标地址使用，表示只在本网络上广播，路由器不转发。
23. ping 127.x.x.x 如果不同，说明TCP/IP协议栈出问题了。不插网线也是可以ping通的。localhost就是该地址。可以代指本机的IP地址。
24. 169.254.0.0这个网段是Windows系统自动获取不到地址时，自己给自己分配的地址。这是一个B类地址。
25. 保留的私网地址：10.0.0.0 1整个A类网段，172.16.0.0-172.31.0.0 16个B类地址，192.168.0.0-192.168.255.0 256个C类地址。
26. 互联网上没有私有地址，路由器不知道如何转发目的地址是私网地址的包。
27. 一般的路由器之间都是点到点的，只要2个可用IP就行了，子网掩码一般设为255.255.255.252，即30位子网掩码，一共四个地址，1个网络地址，2个可用，1个广播地址。
28. 192.168.1.0这个网段种，划分变长子网，可以按照128+64+32+16+…来划分，也可以按照…+16+32+64+128来。低地址分配给大的和小的都可以。相同的切分次数的子网掩码是一样的。但是网络号不同，只能按顺序切割，从大到小或从小到大。
29. 255.255.255.192 这个子网掩码可以供等分4段的子网使用。子网可以是如下几个网段中的任意一个：x.x.x.1-62，x.x.x.65-126，x.x.x.129-190，x.x.x.193-254。
30. 自己的IP地址和子网掩码做与运算，可以得出自己所在网段的网路号，将目标地址和自己的子网掩码做与运算，可以得出目标地址所在网段的的网络号，如果两个网络号相同，则不给路由器，解析MAC地址发送，完成直接交付；如果不相同则给路由器，完成间接交付，一般会将路由器在该网络中接口的IP地址指定给该网络内的各个主机作为默认网关。
31. 如果子网掩码=默认的，那么认为没有划分子网，网络内的主机均可通信。
32. 如下两个ip，192.168.0.193（11000001）/26，和192.168.0.194（11000002）/27。
33. 子网的提出是为了解决以下问题，例如：一个单位有1000台电脑要连接互联网，要分成3个部门，部门独立，因此每个部门都得申请一个B类网络地址，但是此时都有大量剩余=65534-333。此时不如申请一个B类网络地址，然后划分子网给三个部门使用。
34. 划分子网是为了节约使用IP地址。少申请。划分子网相当于是使用一部分主机号当做子网号（不能从网络位借用）。IP地址变为划分子网的3级结构。
35. IP地址和子网掩码做按位与运算，就可以得到子网的网络地址。
36. 划分子网越多，被广播和网络地址所占去的地址就越多。相邻子网的广播地址和网络地址是挨着的。
37. 无分类编制得提出是为了合理利用数量巨大，但地址空间又较小的C类地址。
38. CIDR 无分类域间路由选择。消除了传统的A、B、C类网络和划分子网的概念。使用/记法，/后面是网络前缀所占的比特数量。
39. 128.14.35.7/20 表示前20为是网络号，后12为是主机号。
40. CIDR将网络前缀都相同的连续IP地址组成一个 CIDR 地址块。CIDR中没有子网掩码，有地址掩码。
41. ![1588052230119](计算机网络.assets/1588052230119.png)
42. 路由聚合(也称构造超网)，旨在缩小路由表的规模，节省内存。
43. 相连的路由器会周期性的通告自己知道的路由信息给对方。
44. ![1588052606902](计算机网络.assets/1588052606902.png)
45. 前缀越长，地址块越小，路由越具体，若路由器在查询路由表时，发现有多条路由可以选择，则选择网络前缀最长的那个，这个叫“最长前缀匹配原则”。
46. 子网掩码可以是不一样的，又称为变长子网掩码VLSM。这样每个子网的地址数量不同，较为灵活。如果采用定长子网掩码，只能划分为2^n个子网，n为从主机号借用的位数。
47. 路由器直连的两个端口所在的网络，只用4个号码就可以了，不需要很大的子网。
48. 例如将192.168.0.0/24这个网络分成5个小的网络，要求地址块大小分别为：32、16、16、16、4、
49. 从192.168.0.0到192.168.0.255，一共256个地址，不能随意分配，每个子块的起点位置不能随便选取，只能选取块大小的整数倍的地址。建议先给大块分配地址。
50. 路由表中的下一跳，可以是端口（目的网络位路由器该端口配置的网络地址），也可以是某个网络地址。
51. ![1588056115728](计算机网络.assets/1588056115728.png)
52. R1不连接Internet，192.168.1.0/24中的主机要访问Internet，则需要R1将包转发给R2。因为Internet中的地址众多，无法都一一写到R1的路由条目中，所以使用一个默认路由，来一股脑的将数据包交给R2处理。
53. 也可以为路由器添加一条特定主机路由条目，一般用于网络管理和测试，或安全考虑。
54. ![1588056478806](计算机网络.assets/1588056478806.png)
55. 静态路由配置错误可能导致路由环路。为了防止IP数据包在路由环路中永久兜圈子，在IP数据包中设有生存时间TTL字段（默认64），每经过一个路由器，就会减1，如果减1后等于0，则会被丢弃。
56. 路由表中如果使用了聚合路由技术，可能聚合不存在的网络，当主机要发送数据包到不存在的网络时，会被错误的转发，而此时本不应转发。针对这种情况，可以添加不存在的网络的黑洞路由。null0为路由器内部的虚拟接口，即丢弃。
57. ![1588057028416](计算机网络.assets/1588057028416.png)
58. 路由条目中记录的是网络地址，路由器回将收到的数据包中的目的地址和路由表中的地址掩码相与，如果所得网络地址等于对应的网络地址，则通过该条目对应的端口转发。
59. 广播地址分为两种：①受限的广播地址，255.255.255.255，他不会被路由转发。这种广播一般出现在主机配置阶段，主机不知道自己的IP和子网掩码。②直接广播地址，该网络的广播地址，例如在192.168.0.0/24网络中，为192.168.0.255。该广播会被路由转发。如果目的地址是其他网络的直接广播地址，则不会被路由器转发。
60. 中继器、集线器工作在物理层，不隔离冲突域和广播域。网桥、交换机工作在数据链路层，隔离冲突域，不隔离广播域。交换机工作在网络层，隔离冲突域和广播域。
61. 路由器收到数据包后会检查IP分组头部，如果出错，会丢弃该包，并会传一个ICMP的差错报告。
62. 因特网使用动态路由选择协议，路由器之间可以交换路由信息，同时将因特网划分为许多较小的自治系统AS，各级ISP在系统内外可以采用不同的路由选择协议。IP地址需要精心规划，才可以利用好分层自治的优势。
63. ![1588057455644](计算机网络.assets/1588057455644.png)
64. IGP和EGP中使用了网关的概念，这是在较早的RFC文档中这么写，后来新的RFC文档使用路由代替了网关。所以又称为IRP和ERP。
65. ![1588057651142](计算机网络.assets/1588057651142.png)
66. 路由器可分为两部分：路由选择部分（路由选择处理机运行路由选择协议，与其他路由器交互更新路由表）和分组转发部分。
67. 路由器端口接受到的分组可以是：①普通数据分组，查找转发表②路由器间交换的路由报文，则交给路由选择处理机，更新路由表。
68. 路由表包含从目的网络到下一跳的映射。转发表示从路由表得出的。一般不认真区分二者。
69. 路由器的每个端口都有输入和输出缓冲区。
70. RIP是内部网关协议中最先得到广泛使用的，要求AS内的每一个路由器都要维护一个从它自己到AS内每一个网络的距离，这一组距离成为距离向量。
71. RIP使用跳数来衡量到达目的网络的距离，路由器到直连网络的距离定义为1。路由器到非直连网络的距离为所经过的路由器+1。距离最大等于16，此时表示到该网络不可达。RIP只适用于小型网络。
72. RIP认为好的路由就是距离短的路由，通过的路由器数量少，不考虑带宽的影响。
73. 如果存在不同的路径达到同一个网络，则会都记录下来，等价负载均衡。
74. RIP规定，只和相邻路由器交换自己的路由表，时间间隔可以是每30秒。
75. 路由器在收到相邻路由器的路由表时，首先会将目的网络地址的距离+1，然后权衡利弊，进行选择性的更新或删除自己的路由表中的条目。
76. ![1588084752023](计算机网络.assets/1588084752023.png)
77. OSPF（开放最短路径优先）协议，是为了克服RIP协议的缺点产生的，该协议不受任意一家厂商控制，使用了Dijkstra提出的最短路径算法（SPF）。
78. OSPF是基于**链路状态**的，不会产生路由环路，不限制网络的规模，更新效率快。
79. 链路状态指的是，本路由器和那些路由器相连，以及相应的链路的代价，一般用来表示费用，距离，时延，带宽等，由网络管理人员来决定。
80. 相邻路由器间周期性发送问候分组，10秒一次，如果经过40秒都没有收到hello分组，则认为到该路由器的链路断了。链路通畅后，会给邻居路由器发送自己的数据库描述分组，路由器收到该分组后检查，如果发现有需要的，则再想路由器发送请求分组，获得详细信息。收到该分组后，还会发送一个确认消息。
81. OSPF在多点接入网络（所有路由器都直接相连，类似总线型）中，则hello分组很多，为了避免这种情况，会选举指定路由器DR和备用的指定路由器BDR，所有其他路由器只和DR/BDR发送hello分组。选举原则类似交换机生成树算法中选举根交换机类似。
82. ![1588087298601](计算机网络.assets/1588087298601.png)
83. 为了使OSPF可以应用到很大的网络，可以给自治系统AS划分为更小的区域。洪泛法的范围局限在每个区域内。
84. ![1588087562982](计算机网络.assets/1588087562982.png)
85. 路由器间会定期传播自己直连的网络和相邻路由器之间的链路状态。从而形成带权有向图。
86. 带权有向图，使用Dijkstra的SPF算法，即可得到最短路径。
87. ![1588086723809](计算机网络.assets/1588086723809.png)
88. ![1588086740318](计算机网络.assets/1588086740318.png)
89. 洪泛法：在OSPF协议中，当链路状态发生变化时要用Flooding向所有路由器发送信息。将收到的封包，往所有的可能连结路径上递送，直到封包到达为止。
90. BGP是自治系统之间使用的最广泛的协议。由于不同系统对于**代价**的度量可能是不一样的，所以自治系统之间的路由选择使用代价作为度量是不可行的。
91. BGP的目的是力求找到一条能到达目的网络的路由（不能兜圈子），而非最佳路由。
92. ![1588087740235](计算机网络.assets/1588087740235.png)
93. 每个AS需要选择至少一个路由器作为自己的发言人，一般为BGP边界路由器。不同AS的发言人建立TCP连接，179端口，交换路由信息。然后个发言人构造出达到各AS的较好的路由，树形结构。
94. ![1588088112384](计算机网络.assets/1588088112384.png)
95. IP数据包是可变长的，固定部分20字节，可变部分40字节。首部长度字段使用4位描述，单位是4个字节，最小取5，表示首部有20字节，最大取15，表示首部有60字节。
96. ![1588088587190](计算机网络.assets/1588088587190.png)
97. 由于可选字段长度不定，可能不是4字节的整数倍。此时就需要在末尾填充0，以确保IP数据包的首部是4字节的整数倍。
98. 区分服务是打上一个标记，表示这个数据包的优先程度。需要在主机上和路由器上都配置才可以。属于QoS。
99. 总长度字段中的数值是IP数据包首部+数据载荷的和。
100. 由于IP数据包支持总长度最大为65536个字节，但是以太网的数据链路层规定了帧的数据载荷的最大长度MTU为1500字节。如果超长，则需要将原IP数据报进行分段。将原IP数据报的数据载荷分片后还要调价首部，使其构成IP数据报。
101. ![1588089161449](计算机网络.assets/1588089161449.png)
102. ![1588089470495](计算机网络.assets/1588089470495.png)
103. 分片和原始的标识相同。分片在网络之间传输时，视DF的取值，还可以再分片。
104. IP数据包中的TTL字段，最初以秒作为单位，路由器转发时，将该值减去该数据报在本路由器上花费的时间。现在表示跳数。转发一次就-1。通过TTL字段可以判断对方的操作系统，Windows一般为128，linux一般为64。ping -i 参数可以设置TTL。有些路由器设置了禁ping，这表示ping该主机不同，但是ping数据报经过该主机是可以的。
105. IP数据报中的协议字段标识数据部分是何种协议数据单元（PDU）。

     ```shell
     #常用的一些协议和相应的协议字段值如下
     ICMP IGMP TCP UDP IPV6 OSPF
      1    2    6   17  41   89
     ```
106. 首部检验和字段用来检测首部在传输过程中是否出错，比CRC码简单，成为因特网检验和。IP数据包每经过一个路由器时，都会计算更新首部检验和（因为首部的字段会发生变化）。由于IP层本身不提供可靠传输的服务，计算首部校验和是一项复杂的工作，所以在IPv6中路由器不在计算首部校验和。不检查数据内容。
107. ICMP协议主要用来发送**差错报告报文**和**询问报文**。ICMP报文封装在IP数据包中。目的是为了提高交付成功的机会，
108. 差错报告报文一共有5种：
     1. 终点不可达（路由器不知道如何到达目标网络，会丢弃数据报，回传ICMP报文）
     2. 源点抑制（路由器或主机由于拥塞，而丢弃数据报时，会告诉源点放慢发送速度）
     3. 时间超过（数据报每经过1个路由器后，TTL会-1，如果结果为0，丢弃数据报，回传ICMP），另外终点在预先规定的时间内不能收到一个数据报的全部数据片时，就把已经收到的数据片丢弃，然后回传ICMP。
     4. 参数问题，数据报的首部在校验时发现问题，数据包会被丢弃，然后回传ICMP。
     5. 改变路由（重定向），路由器发现有更好的路到达目的地址，回传ICMP，让源主机知道下次去往目标地址走另一个路由器。主机会在自己的路由表中添加一个条目。
109. 对ICMP差错报告报文不在发送差错报告报文。
110. 多播地址的数据报都不发送ICMP差错报告报文。对特殊地址（127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。
111. ICMP询问报文有两种：回送请求和回答（用来测试目的站是否可达，收到此报文的主机必须回答），时间戳请求和回答（用来时间同步和测量时间，回答报文中有个32位的字段，用来记录从1900年1月1日到现在一共过了多少秒）。
112. ICMP主要应用：

     1. 分组网间探测（Packet InterNet Groper）ping，用来测试主机的连通性。应用层直接使用网络层的ICMP，不使用运输层的TCP或UDP。
     2. 跟踪路由traceroute，主要用来测试IP数据报从源主机到目的主机需要经过多少个路由器。

113. Windows版本：tracert命令，应用层直接使用ICMP协议，使用了回送请求和回答保温以及差错报告报文。

114. Unix版本：traceroute命令，在运输层使用UDP协议，仅使用ICMP差错报告报文。

115. traceroute的原理是发送回送请求报文，但是修改TTL字段，从1开始，来获得路由器的ICMP差错报告报文。逐步增大TTL。直到收到ICMP回送回答报文。
116. 一个路由器有多个IP，traceroute探测到的是自己发送的数据报进入路由器的端口的IP。即面朝自己的端口。从下图可以看出172.18.96.1那个路由器有一个口是连接到公网的。ping命令中TTL越少，表示中间经过的路由器越多，tracert命令显示的中间路由器也就越多。
117. ![1588179889851](计算机网络.assets/1588179889851.png)
118. 专用网：不同地区的网络使用专线连接，租用价格高。也可以利用公用的因特网组建虚拟专用网VPN。
119. 由于IPV4地址资源的紧张，特地划分出一些地址，无需申请就可以使用。

     ```shell
     #专用(私有)地址:
     10.0.0.0    -   10.255.255.255       #(10/8地址块)
     172.16.0.0  -   172.31.255.255     #(172.16/12地址块)
     192.168.0.0 -   192.168.255.255   #(192.168/16地址块)
     ```
120. 通常说路由器不会转发目的地址时私有地址的数据报，这里说的是Internet中的路由器。这是由运营商的边缘路由器（也称为接入路由器，用来连接局域网和因特网）来保证的。路由器默认不认识私有地址，运营商会在接入路由器中设置不转发私有地址。
121. 家中常用的路由器都是1个wan口，多个lan口，这个是用于组建树形网络用的。运营商的路由器不区分，都是wan口。
122. 运营商的路由器分为核心（骨干）路由器和边缘（接入）路由器。
123. 224.0.0.0-239.255.255.255是一组组播（多播）地址。224.0.0.1特指所有主机，224.0.0.2特指所有路由器，224.0.0.5特指所有OSPF路由器。224.0.0.0-224.0.0.255只能用于局域网，路由器是不会转发的。224.0.1.0-238.255.255.255是可以用于Internet的。239.0.0.0-239.255.255.255是私有地址，和192.168.x.x功能一样。
124. 多播是一种一点到多点的通讯方式。可以节省网络带宽。一个多播源吧数据发向特定的多播组，只有加入该组的主机才可以收到该数据包。当一台主机要加入某个多播组时，会通过IGMP协议告诉路由器，当路由器接收到发送给那个多播组的数据包时变化复制多份，发送给组内的所有主机。路由器还会定期询问管理网络内的主机，如果某个多播网络内不存在主机，则不会再接受该多播组的数据包，并汇报多播源。
125. RIP协议存在“坏消息传的慢”的问题，又称为路由环路，距离无穷计数。
126. 基于IPv4的版本有两个，还有基于IPv6的RIPng。
127. 主机如果要发送给不是本网段内的主机信息时，会将数据包发给路由器，此时需要将目标MAC地址写成路由器的，这样交换机才会转发给路由器。路由器在收到数据包时，会查找路由表，确定转发的接口，此时会修改数据包的源和目的MAC地址。MAC地址只在局域网内识别有效。
128. IP地址决定了最终的目的地，MAC地址决定了下一个跳的地址。每经过一个网络层设备，MAC地址会变化。局域网内的计算机识别不了其他网段的主机的MAC地址。
129. ARP协议有中间人攻击的隐患：当主机A想要很本网段的主机B通信时，由于不知道其MAC地址，发送ARP广播请求，此时主机B和C（中间人）都进行了回应，由于主机C的回应次数多，导致主机A认为主机C是其要进行通信的对象，主机A将数据包转发给主机C，然后主机C解析后，在将数据包转发（此处会伪装成主机A的样子）给主机B。
130. P2P终结者是一种利用ARP欺骗，伪装成路由器，来控制局域网内主机上网速度的软件。局域网内的主机先和该主机进行通信，该主机在决定以何种速度和路由器通信。
131. 网络执法官，也是通过ARP欺骗，来控制局域网内那些主机可以通信，那些不可以。
132. ARP防火墙：当解析MAC地址时，是先收到路由器的信息的，此时就将MAC地址固定写死，之后再收到的ARP应答都认为是ARP欺骗。
133. Windows上使用arp -a 查看ARP映射表。
134. 要传输的数据加上IP头部，就构成了IP数据报，也称为数据包。
135. 如果没有手动配置路由的情况下，下图中，左边的主机ping路由器R1的2端口是不通的，数据包能够达到R1，因为R0知道如何到达R2，但是R2不知道如何到达192.168.0.0网段。
136. ![1590247780499](计算机网络.assets/1590247780499.png)
137. 路由表中的条目是目标网段（网络地址+子网掩码）和路由器地址的对应关系。路由器本身不关心到目标主机怎么走，只关心到目标网段怎么走。条目中的路由器地址是接入该网段的路由器。
138. 计算机不是路由器，但也有路由表。**网关就是默认路由**。默认路由对应的网络地址是0.0.0.0，子网掩码也是0.0.0.0。
139. ping的时候一会通（延迟较低），一会断。这表示路由有问题。如果通的延迟较高，那么一般是阻塞问题导致的。
140. 如果一个计算机有2张网卡，分别连接因特网和局域网，那么局域网的那张网卡不用设置网关，因为他该局域网内没有通往因特网的路由器接口。
141. 如果路由器发现到目标网络有多个线路可以走的话，可以设置负载均衡，数据包走不同的线路。
142. windows使用route print 可以查看本机的路由表，可以看到第一条为默认网关。第二条的作用是将127网段的地址都定位到127.0.0.1上。

     ```shell
     IPv4 路由表
     ===========================================================================
     活动路由:
     网络目标                网络掩码             网关           接口        跃点数
               0.0.0.0          0.0.0.0       172.22.0.1   172.22.226.191   55
             127.0.0.0        255.0.0.0         在链路上      127.0.0.1      331
             127.0.0.1  255.255.255.255         在链路上      127.0.0.1      331
       127.255.255.255  255.255.255.255         在链路上      127.0.0.1      331
     ```
143. ping命令发出的ICMP包中数据内容可以任意填写，一般为
144. RIP协议是每隔30S自动广播，OSPF协议是触发时更新，每隔10秒钟，和邻居发送一个hello包，如果没有回应，再进行广播。而RIP协议是每隔一段时间把知道的所有网段都广播出去。
145. VPN，虚拟专用网络：外网计算机想VPN服务器拨号成功之后，获得一个私网地址，之后发送到局域网的数据包会经过两层封装，VPN服务器收到数据包后，会去掉外边的封装，然后转发到内网中。
146. 两个外网的主机拨号到同一个VPN服务器，就可以内网连通。
147. ![1590292114044](计算机网络.assets/1590292114044.png)
148. 拨号到VPN服务器后，还可以设定仅访问VPN内网时，经过VPN服务器，访问外网时，不经过VPN服务器。
149. VPN有多种类型，即多种支持的协议。可以在路由器上配置VPN服务，隧道技术，这样主机连接后就可以直接使用了。
150. ![1590294155606](计算机网络.assets/1590294155606.png)
151. NAT 网络地址转换。局域网的主机发送数据包可以达到因特网的服务器，但是服务器却不知道如何回应。因为局域网的IP是私有的。这样只有具有公网地址的主机才可以访问因特网，但是为了使更多的局域网内的主机能够上网。
152. 私网地址和NAT技术的提出是为了节省IP地址。二者结合使用。
153. 狭义的NAT是只进行IP地址转化，即如果路由器3个公网IP，那么局域网内只能有3个主机同时上网。每个主机上网时，数据包会被路由器进行IP地址转换。路由器会将收到的数据报，替换IP，然后转发给局域网内的主机。该技术并不能节省公网IP地址。
154. 局域网内的两台主机上的QQ传输文件，就会使用内网穿透技术，减少服务器带宽占用。
155. 路由器上运行NAT服务，路由器会将局域网内的数据包的源IP（为了使数据包能够返回来）和端口（为了区分局域网内的不同主机）都进行替换。真正节省IP地址的是PAT端口地址转换。PAT可以看做是NAT的一部分。
156. 端口映射功能可以让外网的计算机访问内网的计算机。端口映射服务器需要有一个公网的IP。然后它将自己的某个端口A映射到内网计算机的某个端口B，凡是在端口A上收到的数据包，一律转发给内网计算机的端口B。
157. 虚拟机配置端口映射：第一行为NAT服务器的端口（此时为真实机端口）。
158. ![1590373913292](计算机网络.assets/1590373913292.png)
159. netstat -n可以查看建立的会话。
160. 虚拟网络编辑器的NAT中需要设置一个网关IP，可以是网段内的任意一个任意，不过需要将虚拟的网管设置成该IP。该IP和主机的NAT网卡地址没关系。
161. IP协议包含RIP、OSPF、BGP等。
162. 使用VLAN可以形式上将一个冲突域分隔开，使用子网掩码可以将一个网络划分为多个子网。前者是基于数据链路层的，后者是基于网络层的。不同的VLAN之间通过三层交换机通信，不通的子网之间可以通过路由器通信。
163. VLAN相当于将一个交换机逻辑地划分为多个交换机，每个交换机的端口变少了。
164. 超网（supernet）是和子网类似的概念，子网是将大网络分为小网络，超网是将小网络组成大网络。
165. 使用子网掩码划分的局域网，不通的子网之间不能直接通信，需要借助路由器。子网A中的主机在首次屏子网B中的主机时，路由器需要发送ARP请求，寻找目的地址的MAC地址，然后写入ARP缓存。这也就是第一次ping不通，后面才可以ping通。

# 传输层

1. 传输层协议的两个应用场景：
   1. TCP 面向连接的，数据过大会进行分段，编号，具有流量控制功能，传输之前需要先建立会话。
   2. UDP 无连接的，通常用于一个数据包就能完成的通信，不建立会话。用于多播。
   
2. 用户进行DNS查询使用UDP，如果发送过去，一段时间后没有收到回应，会再次发送。DNS服务器之间是使用TCP通信的。

3. 传输层提供端到端的传输服务，为进程之间的通信提供服务。端口是标识进程的逻辑符号。之所以不使用进程标识符，是因为不同操作系统对进程的表示不同。

4. 0-1023号端口为熟知端口号，被指派给了最重要的一些应用层协议。

5. 1024-49151号端口为登记端口号，为使用这类端口号必须在IANA进行登记，以防止重复。

6. 49152-65535号为短暂端口号，通信暂时使用。端口号只标识本地的应用进程。

7. 主机接收到数据包时，查看目的端口号，然后决定给那个进程，源端口号没用。

8. 发送数据包时之所以要加入源端口号，是为了方便接收方返回内容时，将其设置为目的端口号。

9. UDP是一次性发送，TCP存在一个缓存的过程。TCP发送方可能发送10个数据块，接收方收到时，可能将其整合为8个数据块交付给应用层。TCP只保证接收方收到的字节流是和发送方一致的，所以说TCP是面向字节流的。

10. UDP适用于IP电话，视频会议等实时应用。UDP首部只有8个字节。

11. http协议使用TCP作为传输层的协议。

    ```
    http      =tcp+80
    https     =tcp+443
    ftp       =tcp+21
    smtp      =tcp+25
    pop3      =tcp+110
    rdp       =tcp+3389
    共享文件夹 =tcp+445
    sql       =tcp+1433
    dns       =udp+53或tcp+53
    ```

12. 端口和具体进程挂钩。服务器上如果开启各种服务（http，ftp）后，会侦听对应的端口请求。

14. SMTP是发送邮件的服务，POP3，IMAP是接受邮件的服务。

15. 设置防火墙可以指定那些端口的流量可以进出。如果A可以ping通B，但B无法ping通A，此时一般是防火墙的问题。

16. 防火墙主要是拦截外部访问，如果内部主动访问外部，则不会拦截。因此对木马程序无效，因为木马是启用后，主动连接制作木马的人。配置出站规则可以使得木马程序无效。

17. TCP传输的内容成为报文段segment，UDP传输的成为报文。

18. UDP首部数据格式：主要是增加了源端口和目标端口还有长度，校验和。

19. ![1590395770509](计算机网络.assets/1590395770509.png)

20. TCP只能提供点对点的通信。负责可靠的传输，全双工通信。面向字节流。

21. 传输数据之前要先确保网络畅通。

22. TCP连接的对象成为套接字socket，实际就是IP地址+端口号。

23. TCP的流量控制是让发送方的发送速率不要过快，要让接收方来得及接收。

24. 滑动窗口机制：接收方调整自己的接受窗口时，发送方也会跟着调整自己的发送窗口。

25. 每个报文段发送后都会有一个重传计时器开始计时，如果到指定时间内，没有收到接收方的确认，则会重传，并重新计时。

26. 当接收方的缓存被占满后，发送一个调整接受窗口为0的报文，发送方接收到以后会调整自己的发送窗口为0，停止发送。但是会启动持续计时器，过了一段时间，如果该计时器超市，则发送一个探测报文，接收放收到该探测报文后，可能会根据情况调整自己的接受窗口并通知发送方。

27. TCP的拥塞控制：如果出现了拥塞，网络设备会丢弃数据包，如果不进行控制，可能会越来越坏。出现死锁。

28. ![1590463241657](计算机网络.assets/1590463241657.png)

29. 发送方维护一个拥塞窗口的状态变量，动态变化，如果网络没有出现拥塞，就增大一下，如果出现，则减小。最开始是1，然后增加为2，4，8，16等。最开始使用慢开始算法，一旦达到慢开始门限值时，使用拥塞避免算法，拥塞窗口只能缓慢变化，±1，而不是成倍变化。

30. 如果没有按时收到确认报文（要进行超时重传），则认为发生了拥塞。

31. 如果发生了拥塞，会将慢开始门限调整为拥塞时拥塞窗口值的一半，并将拥塞窗口值调整为1，重新增长。

32. ![1590464032473](计算机网络.assets/1590464032473.png)

33. 慢开始和拥塞算法是1988年提出的TCP拥塞算法，1990年又新增了两个新的拥塞算法（快重传，快恢复）改进性能。

34. 因为可能出现如下情况，个别报文段可能会丢失，但实际上网络并未发生拥塞，这将导致发送方重新进入慢开始过程，降低了传输效率。

35. 快重传指的是：接收方应该尽快地确认（而不是等到自己发送数据时再捎带确认），以免发送方的超时重传计时器超市。

36. 同时及时收到了失序的报文段，也要立即对已收到的报文段进行重复确认。

37. 发送方一旦连续受到3个对同一个报文段的重复确认（表明接收方一直希望受到该报文段的下一个报文段），则将相应的报文段立即重传。如果此时对该报文段的重传计时器还未超时，则会避免一次拥塞误判。

38. 接收方由于不知道发送方一共要发送多少个报文段，所以无法通知发送方重传。重传之能事由发送方自己的计时器超时，来重传的。

39. 使用快重传可以使网络的性能提高20%左右。

40. 快恢复：发送方一旦受到三个重复的确认，则认为只是丢失了个别的报文段，于是不启动慢开始算法， 而是执行快恢复算法（将慢开始门限值和拥塞窗口值调整为当前的一半，开始执行拥塞避免算法）。

41. ![1590465515229](计算机网络.assets/1590465515229.png)

42. 超时重传时间RTO应该设置为略大于往返时间RTT。往返时间是指，从报文段发送到接收到对该报文段的确认 经历的时间。

43. RTO是动态变化的，太小会导致不必要的重传，太大会产生多余的等待，降低效率。

44. 一般采用平滑RTT计算方法：不是简单地加权平均，新旧占比不同。

45. ![1590465996148](计算机网络.assets/1590465996148.png)

45. RTO根据RTT变化。下式中$RTT_D$为RTT偏差的加权平均，$RTO=RTT_S+4\times RTT_D$。

47. RTT的测量比较复杂，当出现重传报文段时，收到的确认无法判断是对哪一个报文段的确认，针对此种情况，可以这样考虑：只要报文段重传了，就不计入RTT的加权了。但是这样又会引起新的问题，稳妥的办法是当发生重传时，将新的RTO变为旧的2倍。

50. ![1590470575533](计算机网络.assets/1590470575533.png)

51. 停止等待：在不可靠的网络上实现可靠的通信，可以使用确认和重传机制，这种重传是自动进行的，除非收到接收方的确认消息。

57. 停止等待协议的缺点是，信道利用率低，只有收到确认的消息，才会重传下一个。这期间一直在等待。

58. 提高信道利用率的方法可以是：流水线传输，一次多发送几个数据包，不必等待对方的确认。

59. 流水线传输中为了保证可靠传输，发送方会维持一个发送窗口（可以认为是缓存），只有收到发送窗口中第一个数据包的确认，才会向后移动窗口，并将第一个数据包从缓存中扔掉。

60. ![1590397420201](计算机网络.assets/1590397420201.png)

61. 为了提高确认的效率，接收方可以进行累计确认，不用每收到一个数据包都进行一次确认。只确认连续收到的包的最后一个。

62. TCP报文段的首部格式：
    1. 端口使用2个字节编码，最大数65535。序号是指这个报文段内容的第一个字节是整个文件的第多少个字节。
    2. 确认号是接收端收到的最后一个字节在原文件中的顺序+1，即下一个将要传输的数据包的第一个字节。
    3. 数据偏移其实是表示TCP首部的长度。最大为15*4个字节。
    
63. ![1590397641600](计算机网络.assets/1590397641600.png)

64. 客户端和服务器进行三次握手：客户端发送→服务器回答→客户端再发送。

65. 三次握手中交换的信息有，MSS能接受的数据包的最大的长度，Win缓存的最大空间（意味着，如果超过这么多字节没有收到确认，则不再发送）。

66. 首部中len字段表示首部之后内容的长度。

67. TCP运输连接的三个阶段：①建立连接②数据传送③释放TCP链接。

70. 建立连接所要达到的目的：
    1. 使双方能够确认对方的存在。
    2. 使双方能够协商一些参数（最大窗口值，时间戳选项，服务质量）。
    3. 使双方能够对运输实体资源（缓存大小）进行分配。
    
71. 三报文握手建立连接：
    1. 一开始客户端和服务器相关进程都处于==关闭（Closed）状态==。
    2. 然后服务器端进行初始化，创建传输控制块（存储连接表，发送和接受缓存的指针），然后服务器进程进入==监听（Listen）状态==，等待客户端的连接请求。这一步称为被动打开连接。
    3. 客户端进行初始化，创建传输控制块，向服务器进程发送TCP连接请求报文段（SYN=1，seq=x，设置的一个初始值），自身进入==同步已发送状态==。SYN=1的报文段不能携带数据，非常小。这一步称为主动打开连接。
    4. 服务器进程收到客户端的TCP连接请求报文段后，如果同意建立连接，则向客户进程发送连接请求确认报文段（SYN=1，ACK=1，seq=y，ack=x+1），同步位和确认位都被设置成了1，表明它是一个连接请求确认报文段。seq=y，作为服务器进程选择的初始序号。ack=x+1，这是对客户进程所选择的初始序号进行确认。这个报文段也不能携带数据。自身进入==同步已接收状态==。
    5. 客户端收到服务器的确认报文段后，还要发送一个普通的TCP确认报文段（ACK=1，seq=x+1，ack=y+1）。并进入==连接已建立状态==。seq=x+1表明这个报文段是客户端发送的第二个报文段。
    6. 服务器进程收到普通TCP确认报文段后，也进入==连接已建立状态==。
    7. 以上的x和y是由客户进程和服务器进程自由选择的。
    8. ![image-20201025101434560](计算机网络.assets/image-20201025101434560.png)
    
72. 不能省略客户进程的针对连接请求的确认的确认报文段。也就是说不能只进行两次握手。原因如下：为了防止已经失效的连接请求报文段又传入服务器，导致服务器一直等待客户端的响应。

73. ![image-20201025101908102](计算机网络.assets/image-20201025101908102.png)

64. 四报文挥手释放连接，连接的释放可以由任意一方发起，假设客户进程的应用进程通知其主动关闭TCP链接：

    1. 客户进程会发送连接释放报文段（FIN=1，ACK=1，seq=u，ack=v），进入==终止等待1状态==。FIN=1表明是一个链接释放报文段，ACK=1表明对之前收到的报文进行确认。
    2. 服务器进程收到连接释放报文段后，向客户进程发送一个普通的TCP确认报文段（ACK=1，seq=v，ack=u+1），进入==关闭等待状态==。此时TCP服务器进程应该通知其应用进程，客户端要断开连接。
    3. 此时，从客户进程到服务器进程的方向已经被释放了，现在TCP链接出于半关闭状态。也就是说TCP客户进程已经没有数据要发送了，如果服务进程还有数据要发送，客户进程开始可以接受的。
    4. 客户进程收到普通确认报文段后，进入==终止等待2状态==。
    5. 如果此时服务器的应用进程没有数据要发送了，就通知其TCP进程释放链接，服务器进程发送连接释放报文段（FIN=1，ACK=1，seq=w，ack=u+1），并进入==最后确认状态==。    w≠v，表明在半关闭状态下，服务进程又发送了一些数据。ack=u+1，表明半关闭状态下，服务进程没有收到客户进程的新的数据，是对之前收到得报文段的重复确认。
    6. 客户进程收到连接释放报文段后，发送普通确认报文段（ACK=1，seq=u+1，ack=w+1），进入==时间等待状态==。
    7. 服务进程收到确认报文段后，即进入==关闭状态==。客户进程还要等2MSL（最长报文段寿命，RFC793文档建议为2min，对于现在的网路可能太长了）时间后，自动进入==关闭状态==。

76. 最后的2MSL的等待是有必要的，如果客户端针对服务器的连接释放报文段的确认丢失了，且客户端发送完该报文段就直接关闭。则会导致服务器端迟迟收不到确认报文段，重传链接释放报文段，但是此时客户进程已经关闭，造成资源的浪费。

77. 4次挥手，可以看做是双方分别关闭连接。从全连接→半连接→关闭。

78. ![image-20201025120323568](计算机网络.assets/image-20201025120323568.png)

79. 当客户进程和服务进程建立了连接，如果有一方突然出现故障，那么另一方为了避免一直等待下去，可以使用保活计时器机制。

80. ![image-20201025105755865](计算机网络.assets/image-20201025105755865.png)

81. TCP是面向字节流的，对应应用层交付来的数据，如果太大会进行切割，然后加上首部进行发送。TCP的全部功能都体现在首部字段的作用。接收方可以根据首部字段了解到，什么时候一个完整的应用层数据可以接受完毕。

83. 首部类似于IP数据报的首部。

84. ![image-20201025110128859](计算机网络.assets/image-20201025110128859.png)

85. 端口号的目的是为了让主机识别出其上运行的各种进程。序号和确认号的范围是0到2^32-1，当增加到最后一个时，就会从0开始。

86. 序号用来指出本TCP报文段数据载荷的第一个字节的序号（这是用来让接收方有序拼接接收到的一堆报文段中的数据）。

87. 确认号的数值表示，希望收到下一个TCP报文段中数据载荷的第一个字节的序号。同时也是对之前收到的所有数据（字节编号在0到确认号-1之间的所有字节）的确认。

88. 只有当确认标志位ACK=1时，确认号才有效。TCP规定，在连接建立后，所有传送的TCP报文段的ACK标志位都必须置为1。

89. ![image-20201025111222913](计算机网络.assets/image-20201025111222913.png)

90. ![image-20201025111242966](计算机网络.assets/image-20201025111242966.png)

91. 数据偏移的值表示TCP数据载荷的起始部分到TCP报文段的起始部分有多远，实际上是标识了TCP报文段的长度。也表明了如何从TCP报文段的首部获取到数据载荷。以4字节为单位。

92. 保留字段，6bit，保留今后使用，目前应置为0。窗口值是用来做流量控制的。校验和是检验TCP报文段的首部和数据载荷两部分。

93. RST复位标志位，当RST=1时，表明出现了异常，需要释放再重新建立连接。

94. PSH推送标志位，当PSH=1时，接收方收到该标志位时，会尽快上交应用进程，而不必等到接受缓存都填满再向上交付。

96. 实际的抓包演示：

97. ![image-20201118192728173](计算机网络.assets/image-20201118192728173.png)

98. 4-6为客户机和服务器的三次握手，客户端主动建立连接。目的是为了发送一个HTTP 的GET请求，9号包为服务器返回请求的文件。然后服务器主动释放连接。

99. tcp流的内容如下，可以看到抓包显示，服务器回复的是一个js脚本，就是将当前窗口的地址跳转到认证网站。

100. 所以可以认定是学校的服务器拦截了包，伪造了服务器的响应。

101. ```
     top.self.location.href='http://202.118.253.94:8080/eportal/index.jsp'
     ```

89. ![image-20201118194931109](计算机网络.assets/image-20201118194931109.png)

# 应用层

1. 是计算机网络的最顶层，也是计算机网络中发展最快的部分。

2. 常见的网络应用包含：万维网WWW，域名系统DNS，动态主机配置DHCP，电子邮件，文件传送FTP，P2P文件共享，多媒体网络应用。

3. 网络应用程序的组织方式：C/S方式和P2P方式。

4. 服务器总是处于运行状态，等待客户的请求，服务器具有固定的IP地址和服务端口。WWW，电子邮件等都是C/S架构。是集中型的。

5. P2P型中，各方即使服务者，又是请求者，他们之间相互直接通信。是分散型的。可扩展性好，因为每增加一个用户，既增加了请求者，也增加了服务者。

6. DHCP可以替代手工配置主机的网络信息。主机开机后，启动DHCP，自动向服务器请求获取自己的网络配置信息，服务器从资源池中分配一个给对应的主机。也是C/S架构，服务器上运行着DHCP服务进程。使用UDP提供服务。服务器端口为67，客户端口为68。
   1. 客户机广播发送DHCP发现报文，原地址为0.0.0.0目的地址为255.255.255.255。此时主机不知道网络中DHCP服务器的地址，因此采用广播。里边封装有客户端的MAC地址。
   2. DHCP服务器接收到该广播后，根据广播中的MAC地址查找自己的数据库，构建配置信息发送DHCP提供报文，也是广播发送。
   3. DHCP客户收到广播包后，判断是否是发给自己的，按照配置信息进行配置。

7. DHCP服务器在从自己的地址池中选择IP给客户机之前，会使用ARP协议确保所选IP地址未被其他主机占用。DHCP客户机也会使用ARP协议确保DHCP提供的IP未被其他主机占用。

8. 每个IP都有一个租用期，当租用期过半后，DHCP客户会向服务器发送请求报文，请求更新租用期。如果DCHP服务器同意，则客户机可以更新租用期。

9. ![image-20201025151010550](计算机网络.assets/image-20201025151010550.png)

10. 由于路由器将不同的网络进行了分割，DHCP广播包不能穿过路由器，所以需要在每个网络内配置一个DHCP服务器。或者也可以给路由器配置DHCP服务器地址，实质成为DHCP中继代理。此时路由器收到DHCP广播后，会单播发送给另一个网络中的DHCP服务器。

11. DNS，用户主机在访问某个域名时，首先会在自己的DNS高速缓存中查找，如果没有则向DNS服务器查询。DNS服务器中有域名和IP地址映射关系的数据库。

12. 因特网的规模很大，为了更高的安全性，DNS服务器也不能只有一个。现在DNS是分布式的层次化的系统，即使少量服务器出现故障，也不会影响整个因特网的性能。

13. 域名时层次化的树状结构，用.分割，每一级都有英文字母和数字组成，不超过63个字符，不区分大小写。级别高的写在右边。完整的域名不超过255个字符。各级域名有其上一级的域名管理机构管理，最高层的为ICANN。

    ```
    nic .hnust .edu  .cn
    四级  三级  二级  顶级
    ```

14. 顶级域名分为三类：

    1. 国家，cn中国，us美国，uk英国。
    2. 通用型的，com公司企业，net网络服务机构，org非营利性组织，int国际组织，edu美国教育部门，gov美国政府部门，mil美国军事机构。
    3. 反向域名解析arpa，用于将IP地址解析为域名。

15. 我国将二级域名分为两类：

    1. 类别域名，共7个：ac(科研机构)、com(企业)、edu(教育机构)、gov(政府部门)、net(提供网络服务的机构)、mil(军事机构)、org(非营利性组织)
    2. 行政区域名，共34个，对应于所有的省自治区，直辖市。bj表示背景，sh表示上海等。

16. 域名知识一个逻辑概念，并不代表物理位置。

17. 显然不能将所有的域名IP映射信息存储在一台服务器中，因此使用分布式的。

18. 根域名服务器，13个，他们之间相互知道对方。根域名服务器并不直接对域名进行解析，而是返回该域名所属顶级域名的对应的根域名服务器的IP地址。

19. 每个主机的域名必须在某个权限域名服务器注册登记。每个ISP或大学，学院都有一个本地域名服务器，主机一般距离不超过几个路由器。

20. 域名解析过程：

21. ![image-20201025191357073](计算机网络.assets/image-20201025191357073.png)

22. 域名服务器中都广泛使用了高速缓存，用来存放最近查询过的域名映射信息。

23. 由于域名到IP的映射关系不是永久不变的，所以域名服务器应为每项映射关系设计计时器，超过时间应该删除重新查询。

24. 用户主机中也有高速缓存。也会定期删除。

25. 根域名服务器中的记录很少，也就几百条数据。

26. FTP（File Transfer Program）屏蔽了操作系统的细节，适用于在异构网络中任意计算机之间的传输。互联网的早起，FTP传输文件所产生的流量很高，后来才被WWW的通信量超过。也是C/S架构。

27. FTP服务器监听21端口，客户端从随机端口发起TCP连接，建立控制命令通道。当有数据要传输时，FTP客户通过命令通道，通知服务器要传输数据了。然后FTP客户端使用临时端口号和服务器的20端口。控制连接一直存在，用于传输FTP的控制命令，而数据连接仅在每次要传输文件时才打开。

28. FTP有主动和被动模式。建立数据通道时，由服务器主动连接客户端是主动模式。主动方式和被动方式下，数据连接所使用的端口不同，主动方式下服务器使用20端口建立数据连接，被动方式下，服务器和客户端协商端口。

29. ![image-20201025220902787](计算机网络.assets/image-20201025220902787.png)

30. 电子邮件的普及，替代了电报业务。也是C/S架构。电子邮件系统由三大部分构成：用户代理（用户使用的客户端软件），邮件服务器（基础设施，所有的ISP都有邮件服务器，功能是收发邮件还有维护用户的邮箱），所需协议（发送协议，例如SMTP和读取协议，例如POP3，IMAP）。

31. ![image-20201025222033170](计算机网络.assets/image-20201025222033170.png)

32. ![image-20201025222148085](计算机网络.assets/image-20201025222148085.png)

33. SMTP 简单邮件传送协议。发送方会周期性地扫描邮件缓存，如果有待转发的邮件，则与接收方的服务器建立TCP连接，端口25。接收端要确认发送端的有效性，决定是否接受，发送端来要询问接收服务器是否有对应的收件人地址，决定是否发送。发送完数据后，客户端请求断开链接。

34. 电子邮件的格式不是有SMTP规定的，而是由RFC5322规定的，电子邮件由信封和内容两部分构成，内容又由首部和主体两部分构成。

35. 最重要的关键词是收件人地址和主题。信封上的信息是自动从首部提取的。

36. ![image-20201025223448540](计算机网络.assets/image-20201025223448540.png)

37. 抄送人和收件人不同，抄送人收到邮件后，可看也可以不看，可回也可以不回复。

38. SMTP只能传输ASCII码文本数据，不能传送二进制对象，例如图片，也不能传送非英语国家文字。因此发展出了MIME。如果遇到非ASCII数据，则会使用MIME将其转化为ASCII数据。接收方也要使用MIME进行逆转化。

39. 实际上MIME后来也用于面向ASCII的HTTP。

40. 常用的两个邮件读取协议，都是基于TCP的C/S架构，POP3使用110端口，IMAP4使用143端口。

41. ![image-20201025223830476](计算机网络.assets/image-20201025223830476.png)

42. 现在越来越多的用户使用浏览器来进行收发邮件，不用专门的邮件客户端，这种方式类似于IMAP。客户和服务器之间使用HTTP协议来收发邮件，邮件服务器之间还是使用上述的SMTP协议发送。

43. 万维网WWW并非是某种网络，而是一个大规模的联机式的，信息储藏所。利用网页之间的超链接将他们连接起来。1989年创建。

44. 浏览器最重要的是渲染引擎，也就是内核，负责对网页内容进行解析和显示。不同的内核对网页内容的解析可能不同，因此需要进行测试。

    ```
    Chrome    Firefox   Safari   Opera    IE
    Blink     Gecko     WebKit   Blink    Trident
    ```

45. 为了方便地访问世界范围内的文档，WWW使用URL（统一资源定位符）来指明资源的位置。由以下4部分组成：

    ```
    <协议> :// <主机>        :<端口>  /<路径>
    http   :// www.hnust.cn :80      /index.com
    ```

47. HTTP定义了浏览器和服务器通信的规则，HTTP/1.0采用非持续连接，每次浏览器请求文件时，都要建立1次连接，收到后就立即释放。

# NetBIOS

1. NetBIOS名称是NetBIOS协议中所定义的一种网络标识符，用于网络通信和资源共享，由16个字符组成，前15个是计算机名，最后一个是NetBIOS提供的后缀名。
2. WINS是微软开发的域名服务，他和DNS不同，前者通过NetBIOS名称解析IP，工作在某个网络内部，后者通过域名解析IP，工作在整个互联网上。WINS为NetBIOS提供名字注册，更新，释放，解析服务。它还可以辅助DNS的查询。
3. 大型网络内部都会部署WINS服务器，因为	默认状态下，网络中的主机是通过广播的形式来询问NetBIOS名字的，如下：
4. ![1588044802760](计算机网络.assets/1588044802760.png)
5. 但是如果配置了WINS服务器，就可以避免广播太多，主机直接向WINS服务器查询。WINS服务器地址可以通过DHCP一同下发。
6. nbtstat -n 可以查看主机的网卡已注册的NetBIOS名字。

   ```shell
   WLAN:
   节点 IP 址址: [172.22.226.191] 范围 ID: []
                   NetBIOS 本地名称表
          名称               类型         状态
   ---------------------------------------------
       DESKTOP-R2R1L2Q<20>  唯一          已注册
       DESKTOP-R2R1L2Q<00>  唯一          已注册
       WORKGROUP      <00>  组            已注册
   ```
7. 一般的电脑的NetBIOS节点类型都是混合，即先向WINS服务器请求，解析失败在使用NetBIOS广播。

   ```shell
   ipconfig /all
   Windows IP 配置
      主机名  . . . . . . . . . . . . . : DESKTOP-R2R1L2Q
      主 DNS 后缀 . . . . . . . . . . . :
      节点类型  . . . . . . . . . . . . : 混合
      IP 路由已启用 . . . . . . . . . . : 否
      WINS 代理已启用 . . . . . . . . . : 否
   ```
8. 由于DNS逐步取代WINS，微软没有在对WINS更新，使其支持IPv6。
9. 类似于DNS的Host文件，WINS也有一个类似的，是lmhosts文件。不同的是，lmhosts是优先级最低，hosts是优先级最高。使用 net use命令来解析NetBIOS，如果都解析不成，才会使用DNS解析。











